/* eslint-disable import/no-default-export -- cobalt plugins do this */

// @ts-check

import { defaultTransformer } from '@cobalt-ui/plugin-js';
import { set } from '@cobalt-ui/utils';

const STRIP_TABS = /^\t{3}|\t{2}/gm;

// TODO: These should be moved to a common module and imported
const pxToRem = (/** @type {number} */ px) => px / 16;
const pxStringToRem = (/** @type {string} */ px) =>
	pxToRem(pxStringToNumber(px));
const pxStringToNumber = (/** @type {string} */ px) => Number(px.slice(0, -2));
const fontArrayToString = (/** @type {string[]} */ fonts) =>
	fonts.map((name) => (name.includes(' ') ? `"${name}"` : name)).join(', ');

/**
 * @param {{ filename: string; }} options
 * @returns {import('@cobalt-ui/core').Plugin}
 */
export default function pluginBreakpoints(options) {
	return {
		name: 'plugin-typography',

		config(/* config */) {},
		async build({ tokens /* metadata, rawSchema */ }) {
			const header = `/**
* Autogenerated from design-tokens/tokens.json.
* DO NOT EDIT!
*/

`;
			// this is where we'll store the transformed tokens
			/** @type {Object.<string, string>} */
			const transformedTokens = {};

			/** @type {Object.<string, string>} */
			const jsDoc = {};

			// We can re-use the default transformer from `@cobalt-ui/plugin-js`
			// TODO: Filter out typography presets rather than transforming all tokens
			for (const token of tokens) {
				set(transformedTokens, token.id, defaultTransformer(token));
				if (token.$description) {
					jsDoc[token.id] = token.$description;
				}
			}

			/** @type {Object.<!string, string>} */
			const typographyPresets = transformedTokens.typographyPresets;

			/**
			 * TODO: Output any comments from `$description` fields
			 * TODO: Generate `--source-text-decoration-thickness` custom property
			 */

			const typescriptSource = Object.entries(typographyPresets)
				.map(
					([preset, properties]) => `
					export const ${preset} = \`
						font-family: ${fontArrayToString(properties.fontFamily)};
						font-size: ${pxStringToRem(properties.fontSize)}rem;
						line-height: ${properties.lineHeight};
						font-weight: ${properties.fontWeight};
						font-style: ${properties.fontStyle};
					\`;
				`,
				)
				.join('')
				.replace(STRIP_TABS, '');

			return [
				{
					filename: options.filename,
					contents: header + typescriptSource,
				},
			];
		},
	};
}
