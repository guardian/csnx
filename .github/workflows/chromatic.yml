name: Chromatic

on:
  workflow_call:
    secrets:
      CHROMATIC_SOURCE_FOUNDATIONS_TOKEN:
        required: true
      CHROMATIC_SOURCE_REACT_COMPONENTS_TOKEN:
        required: true
      CHROMATIC_SOURCE_REACT_COMPONENTS_DEVELOPMENT_KITCHEN_TOKEN:
        required: true

jobs:
  deploy:
    permissions:
      checks: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - lib: source-foundations
            token: CHROMATIC_SOURCE_FOUNDATIONS_TOKEN
          - lib: source-react-components
            token: CHROMATIC_SOURCE_REACT_COMPONENTS_TOKEN
          - lib: source-react-components-development-kitchen
            token: CHROMATIC_SOURCE_REACT_COMPONENTS_DEVELOPMENT_KITCHEN_TOKEN
    steps:
      - name: Checkout - On Pull Request
        uses: actions/checkout@v4
        if: ${{ github.event_name == 'pull_request'}}
        with:
          fetch-depth: 0
          # By default the pull_request event will run on a ephermeral merge commit which simulates a merge between the pull request
          # and the target branch. This can cause issues with Chromatic https://www.chromatic.com/docs/turbosnap#github-pullrequest-triggers
          # Hopefully by checking out the HEAD commit of a PR instead of the merge commit we can avoid some of those issues.
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Checkout - On Push Event
        uses: actions/checkout@v4
        if: ${{ github.event_name == 'push'}}
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-env

      # This will just retrieve the output from Nx's build cache.
      # It's simpler than using github actions cache.
      - run: make build-storybooks

      - uses: chromaui/action@v10
        with:
          projectToken: ${{ secrets[matrix.token] }}
          token: ${{ secrets.GITHUB_TOKEN }}
          storybookBaseDir: 'dist/storybook/libs/@guardian/${{ matrix.lib }}'
          storybookBuildDir: 'dist/storybook/libs/@guardian/${{ matrix.lib }}'
          exitOnceUploaded: true
          onlyChanged: '!(main)' # turbosnap on non-main branches
          debug: true
          skip: |
            github.event.pull_request.user.login == 'dependabot[bot]' ||
            github.event.pull_request.user.login == 'gu-changesets-release-pr[bot]'
